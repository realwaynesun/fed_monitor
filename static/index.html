<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wayne's Macro Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --bg-primary: #0e1117;
            --bg-secondary: #1a1d24;
            --bg-card: #262730;
            --text-primary: #fafafa;
            --text-secondary: #a0a0a0;
            --accent-cyan: #00d4ff;
            --accent-coral: #ff6b6b;
            --accent-teal: #4ecdc4;
            --accent-yellow: #ffe66d;
            --border-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        header .meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .alerts-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .alert-box {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid;
        }

        .alert-box.critical { border-color: #ff4444; }
        .alert-box.warning { border-color: #ffaa00; }
        .alert-box.info { border-color: #00aaff; }

        .alert-box h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .alert-box.critical h3 { color: #ff4444; }
        .alert-box.warning h3 { color: #ffaa00; }
        .alert-box.info h3 { color: #00aaff; }

        .alert-count {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .alert-item {
            font-size: 0.85rem;
            padding: 8px 0;
            border-top: 1px solid var(--border-color);
        }

        .alert-item strong {
            color: var(--accent-cyan);
        }

        .chart-container {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .table-container {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .table-container h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            font-family: 'SF Mono', Monaco, monospace;
        }

        tr:hover {
            background: rgba(255,255,255,0.03);
        }

        .positive { color: #4ecdc4; }
        .negative { color: #ff6b6b; }

        footer {
            margin-top: 50px;
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        footer a {
            color: var(--accent-cyan);
            text-decoration: none;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            header h1 { font-size: 1.4rem; }
            .alerts-panel { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Wayne's Macro Dashboard</h1>
            <div class="meta" id="header-meta">Loading...</div>
        </header>

        <div id="alerts-section"></div>
        <div id="charts-section"><div class="loading">Loading charts...</div></div>
        <h2 class="section-title">Data Tables</h2>
        <div id="tables-section"><div class="loading">Loading tables...</div></div>

        <footer>
            Wayne's Macro Dashboard 路
            <a href="https://opensource.org/licenses/MIT">MIT</a> 路
            <a href="https://github.com/realwaynesun/fed_monitor">GitHub</a>
        </footer>
    </div>

    <script>
        // Color palette
        const COLORS = [
            '#00D4FF', '#FF6B6B', '#4ECDC4', '#FFE66D',
            '#95E1D3', '#F38181', '#AA96DA', '#FCBAD3'
        ];

        // Plotly dark theme layout
        const LAYOUT_BASE = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#fafafa', family: '-apple-system, sans-serif' },
            xaxis: {
                gridcolor: '#333',
                linecolor: '#333',
                tickformat: '%b %Y'
            },
            yaxis: {
                gridcolor: '#333',
                linecolor: '#333'
            },
            hovermode: 'x unified',
            legend: {
                orientation: 'h',
                yanchor: 'bottom',
                y: 1.02,
                xanchor: 'right',
                x: 1
            },
            margin: { t: 40, r: 20, b: 50, l: 60 }
        };

        // Format numbers for display
        function formatValue(value, unit) {
            if (value === null || value === undefined) return 'N/A';
            if (unit === 'usd_millions') {
                if (Math.abs(value) >= 1000000) return (value / 1000000).toFixed(1) + 'T';
                if (Math.abs(value) >= 1000) return (value / 1000).toFixed(0) + 'B';
                return value.toFixed(0) + 'M';
            }
            if (unit === 'usd_billions') {
                if (Math.abs(value) >= 1000) return (value / 1000).toFixed(1) + 'T';
                return value.toFixed(1) + 'B';
            }
            if (unit === 'percent' || unit === 'bps') return value.toFixed(2);
            if (unit === 'ratio') return value.toFixed(3);
            return value.toFixed(2);
        }

        function formatChange(value) {
            if (value === null || value === undefined) return '';
            const sign = value > 0 ? '+' : '';
            return sign + value.toFixed(2);
        }

        // Render alerts
        function renderAlerts(alerts) {
            const section = document.getElementById('alerts-section');
            const { critical, warning, info } = alerts;

            let html = '<div class="alerts-panel">';

            // Critical
            html += `<div class="alert-box critical">
                <h3>Critical</h3>
                <div class="alert-count">${critical.length}</div>
                ${critical.map(a => `<div class="alert-item"><strong>${a.key}</strong>: ${a.note}</div>`).join('')}
            </div>`;

            // Warning
            html += `<div class="alert-box warning">
                <h3>Warning</h3>
                <div class="alert-count">${warning.length}</div>
                ${warning.map(a => `<div class="alert-item"><strong>${a.key}</strong>: ${a.note}</div>`).join('')}
            </div>`;

            // Info
            html += `<div class="alert-box info">
                <h3>Info</h3>
                <div class="alert-count">${info.length}</div>
                ${info.map(a => `<div class="alert-item"><strong>${a.key}</strong>: ${a.note}</div>`).join('')}
            </div>`;

            html += '</div>';
            section.innerHTML = html;
        }

        // Render a single chart
        function renderChart(container, chartData, index) {
            const div = document.createElement('div');
            div.className = 'chart-container';
            div.id = `chart-${index}`;
            container.appendChild(div);

            const traces = chartData.series.map((s, i) => {
                const trace = {
                    x: s.dates,
                    y: s.values,
                    name: s.label,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: COLORS[i % COLORS.length], width: 2 },
                    marker: { size: 3 }
                };

                if (chartData.type === 'area') {
                    trace.fill = 'tozeroy';
                    trace.fillcolor = COLORS[i % COLORS.length] + '4D'; // 30% opacity
                }

                return trace;
            });

            const layout = {
                ...LAYOUT_BASE,
                title: { text: chartData.title, font: { size: 14 } },
                height: chartData.height || 400,
                yaxis: { ...LAYOUT_BASE.yaxis, title: chartData.y_label }
            };

            // Add reference line if specified
            if (chartData.reference_line !== null) {
                layout.shapes = [{
                    type: 'line',
                    x0: 0, x1: 1, xref: 'paper',
                    y0: chartData.reference_line, y1: chartData.reference_line,
                    line: { color: 'gray', width: 1, dash: 'dash' }
                }];
            }

            Plotly.newPlot(div.id, traces, layout, { responsive: true, displayModeBar: false });
        }

        // Render all charts
        function renderCharts(charts) {
            const section = document.getElementById('charts-section');
            section.innerHTML = '';

            charts.forEach((chart, i) => {
                renderChart(section, chart, i);
            });
        }

        // Render tables
        function renderTables(tables) {
            const section = document.getElementById('tables-section');
            section.innerHTML = '';

            tables.forEach(table => {
                const div = document.createElement('div');
                div.className = 'table-container';

                let html = `<h3>${table.title}</h3>`;
                html += '<table><thead><tr><th>Metric</th><th>Date</th><th>Value</th>';

                // Add column headers for changes/rolling
                table.columns.filter(c => c !== 'value').forEach(col => {
                    html += `<th>${col.toUpperCase()}</th>`;
                });
                html += '</tr></thead><tbody>';

                table.rows.forEach(row => {
                    html += '<tr>';
                    html += `<td>${row.label}</td>`;
                    html += `<td>${row.date}</td>`;
                    html += `<td>${formatValue(row.value, row.unit)}</td>`;

                    table.columns.filter(c => c !== 'value').forEach(col => {
                        const val = row[col];
                        const formatted = formatChange(val);
                        const cls = val > 0 ? 'positive' : (val < 0 ? 'negative' : '');
                        html += `<td class="${cls}">${formatted}</td>`;
                    });

                    html += '</tr>';
                });

                html += '</tbody></table>';
                div.innerHTML = html;
                section.appendChild(div);
            });
        }

        // Load and render data
        async function loadDashboard() {
            try {
                const response = await fetch('data.json');
                const data = await response.json();

                // Update header
                const meta = document.getElementById('header-meta');
                const generated = new Date(data.generated_at).toLocaleString();
                meta.textContent = `Data: ${data.date_range.start} to ${data.date_range.end} 路 Generated: ${generated} 路 Config v${data.config_version}`;

                // Render sections
                renderAlerts(data.alerts);
                renderCharts(data.charts);
                renderTables(data.tables);

            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('charts-section').innerHTML =
                    `<div class="loading">Error loading data: ${error.message}</div>`;
            }
        }

        // Initialize
        loadDashboard();
    </script>
</body>
</html>
